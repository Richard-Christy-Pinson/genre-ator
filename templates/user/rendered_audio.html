<style>
    .audio-visualizer2-container {
        display: flex;
        justify-content: space-between;
        align-items: center;
        width: 97%;
        height: 40vh;
        margin: 0 20px;
        background-color: #222;
        border-radius: 10px;
    }

    .audio-section2 {
        flex: 1;
        text-align: center;
        width: 90%;
    }

    .audio-section2 audio {
    }

    .visualizer2-section {
        flex: 2;
        display: flex;
        flex-direction: column;
        align-items: center;
    }

    #visualizer2 {
        width: 45rem;
        height: 22rem;
        background-color: black;
        border-radius: 8px;
    }

    .visualizer2-buttons {
        margin-top: 10px;
    }

    .visualizer2-buttons button, .visualizer-controls button {
        padding: 8px 16px;
        margin: 5px;
        border: none;
        background: linear-gradient(45deg, #ff0000, #ffcc00);
        color: white;
        font-weight: bold;
        border-radius: 5px;
        cursor: pointer;
        transition: 0.3s;
    }

    .visualizer2-buttons button:hover {
        transform: scale(1.1);
    }
</style>

<div class="audio-visualizer2-container">
    <div style="display: flex; flex-direction: column; justify-content: center; align-items: center; width: 50%;">

        <!-- IN STUDIO PAGE -->
        {% if current_route == 'user_actions.studio' %}
            <h3 style="color: white; margin: 1rem" id="player2-title">
                {% if song_data.rendered == '' or not(song_data.rendered) %}
                    Not rendered yet
                {% elif song_data.rendered %}
                    Rendered Audio:
                {% endif %}
            </h3>
            {% if song_data.rendered != '' %}
                <div class="audio-section2">
                    <audio id="audioPlayer2" controls
                           src="{{ url_for('static', filename='audios/rendered/' + song_data.rendered) if song_data and song_data.rendered else '' }}">
                    </audio>
                </div>
            {% endif %}

            {% if song_data.rendered %}
                <a id="downloadButton" href="{{ url_for('static', filename='audios/rendered/' + song_data.rendered) if song_data and song_data.rendered else '' }}" download>
                    <div class="button" id="download_tooltip_btn" data-tooltip={{ song_data.file_size_mb }} >
                        <div class="button-wrapper">
                            <div class="text">Download</div>
                            <span class="icon">
                            <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" width="2em"
                                 height="2em"
                                 preserveAspectRatio="xMidYMid meet" viewBox="0 0 24 24">
                              <path fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"
                                    stroke-width="2"
                                    d="M12 15V3m0 12l-4-4m4 4l4-4M2 17l.621 2.485A2 2 0 0 0 4.561 21h14.878a2 2 0 0 0 1.94-1.515L22 17"/>
                            </svg>
                        </span>
                        </div>
                    </div>
                </a>
            {% endif %}
            <!-- IN STUDIO PAGE -->

            <!-- IN SPLITTER PAGE -->
        {% elif current_route == 'user_actions.splitter' %}
            <h3 style="color: white; margin: 1rem" id="player2-title">
                Not rendered yet
            </h3>
            <div class="audio-section2">
                <audio id="audioPlayer2" controls
                       src="{{ url_for('static', filename='audios/rendered/' ) }}">
                </audio>
            </div>

            <a id="downloadButton" href="#" download style="display: none">
                <div class="button" data-tooltip="" id="download_tooltip_btn">
                    <div class="button-wrapper">
                        <div class="text">Download</div>
                        <span class="icon">
                            <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" width="2em"
                                 height="2em"
                                 preserveAspectRatio="xMidYMid meet" viewBox="0 0 24 24">
                              <path fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"
                                    stroke-width="2"
                                    d="M12 15V3m0 12l-4-4m4 4l4-4M2 17l.621 2.485A2 2 0 0 0 4.561 21h14.878a2 2 0 0 0 1.94-1.515L22 17"/>
                            </svg>
                        </span>
                    </div>
                </div>
            </a>
        {% endif %}'
        <!-- IN SPLITTER PAGE -->

    </div>

    <div class="visualizer2-section">
        <canvas id="visualizer2"></canvas>
        <div class="visualizer2-buttons">
            <button id="lineVisualizer2Btn">Line Visualizer</button>
            <button id="barVisualizer2Btn">Bar Visualizer</button>
        </div>
    </div>
</div>

<script>
    document.addEventListener("DOMContentLoaded", function () {
        const audioPlayer2 = document.getElementById("audioPlayer2");
        const canvas2 = document.getElementById("visualizer2");
        const canvasCtx2 = canvas2.getContext("2d");

        canvas2.width = 800;
        canvas2.height = 200;

        let audioCtx2, analyser2, source2;
        let currentVisualizer2 = 'line';

        document.getElementById("lineVisualizer2Btn").addEventListener("click", function () {
            currentVisualizer2 = 'line';
            visualize2();
        });

        document.getElementById("barVisualizer2Btn").addEventListener("click", function () {
            currentVisualizer2 = 'bar';
            visualize2();
        });

        function setupAudioVisualizer2() {
            if (!audioCtx2) {
                audioCtx2 = new (window.AudioContext || window.webkitAudioContext)();
                analyser2 = audioCtx2.createAnalyser();
                analyser2.fftSize = 512;
                analyser2.smoothingTimeConstant = 0.95;
                analyser2.minDecibels = -85;
                analyser2.maxDecibels = 10;

                source2 = audioCtx2.createMediaElementSource(audioPlayer2);
                source2.connect(analyser2);
                analyser2.connect(audioCtx2.destination);
            }
            visualize2();
        }

        function visualize2() {
            requestAnimationFrame(visualize2);

            const bufferLength2 = analyser2.frequencyBinCount;
            const dataArray2 = new Uint8Array(bufferLength2);
            analyser2.getByteFrequencyData(dataArray2);

            canvasCtx2.fillStyle = "black";
            canvasCtx2.fillRect(0, 0, canvas2.width, canvas2.height);

            if (currentVisualizer2 === 'line') {
                visualizeLine2(dataArray2, bufferLength2);
            } else if (currentVisualizer2 === 'bar') {
                visualizeBar2(dataArray2, bufferLength2);
            }
        }

        function visualizeLine2(dataArray2, bufferLength2) {
            const lineWidth2 = 2;
            let x2 = 0;
            const step2 = canvas2.width / bufferLength2;

            canvasCtx2.beginPath();
            canvasCtx2.moveTo(0, canvas2.height - dataArray2[0]);

            for (let i = 1; i < bufferLength2; i++) {
                const value2 = dataArray2[i];
                const y2 = canvas2.height - value2;
                x2 += step2;
                canvasCtx2.lineTo(x2, y2);
            }

            const gradient2 = canvasCtx2.createLinearGradient(0, 0, canvas2.width, 0);
            gradient2.addColorStop(0, "rgb(250,0,0)");
            gradient2.addColorStop(1, "rgb(255,213,0)");
            canvasCtx2.strokeStyle = gradient2;
            canvasCtx2.lineWidth = lineWidth2;
            canvasCtx2.stroke();
        }

        function visualizeBar2(dataArray2, bufferLength2) {
            const barWidth2 = (canvas2.width / bufferLength2) * 2.5;
            let x2 = 0;

            const gradient2 = canvasCtx2.createLinearGradient(0, 0, canvas2.width, 0);
            gradient2.addColorStop(0, "rgb(250,0,0)");
            gradient2.addColorStop(1, "rgb(255,213,0)");

            for (let i = 0; i < bufferLength2; i++) {
                const barHeight2 = dataArray2[i];

                canvasCtx2.fillStyle = gradient2;
                canvasCtx2.fillRect(x2, canvas2.height - barHeight2, barWidth2, barHeight2);
                x2 += barWidth2 + 1;
            }
        }

        audioPlayer2.addEventListener("play", setupAudioVisualizer2);
    });
</script>